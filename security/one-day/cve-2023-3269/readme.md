# StackRot (CVE-2023-3269)

## 리눅스 커널 권한 상승 취약점

리눅스 커널 버전 6.1부터 6.4까지 "Stack Rot"이라고도 알려진 스택 확장 처리에서 발견된 취약점입니다.  
`Maple Tree`는 MM 쓰기 락을 올바르게 획득하지 않고 노드 교체를 수행할 수 있고 이로 인해 use-after-free 문제가 발생할 수 있습니다.  
권한 없는 로컬 사용자가 이 취약점을 이용하여 커널을 침해하고 권한을 상승시킬 수 있습니다.

StackRot은 메모리 관리 서브 시스템에서 발견되는 리눅스 커널 취약점이므로 거의 모든 커널 구성에 영향을 미치며 트리거하려면 최소한의 권한이 필요합니다.

RCU 콜백을 사용하여 메이플 노드가 해제됩니다.
하지만, 실제 메모리 할당 해제가 RCU grace-period 이후까지 지연된다는 점에 유의해야 합니다.

- RCU를 통해 데이터를 관리하는 경우, 데이터 구조의 변경이 발생하면 일정한 대기 기간(Grace-period)가 있습니다.
- 갱신되지 않은 데이터를 참조하는 스레드가 있는지 확인하기 위함이며 모든 쓰기 작업 쓰레드가 완료된 이후 대기 기간이 종료됩니다.

## 사전 지식

### Maple Tree

가상 메모리 영역을 관리하며 가상 메모리 영역을 나타내는 노드를 계층적 구조로 표현한 것 입니다.

- 리눅스 커널 6.1에 적용되었습니다.
- 페이지 단위로 메모리를 관리합니다.
- 각 노드는 가상 주소 범위와 그에 해당하는 물리 주소를 포함합니다.

프로세스가 동작하며 메모리 공간이 동적으로 할당/해제됩니다.

- 이때, 가상 메모리 영역의 할당과 해제를 담당합니다.
- 페이지 폴트(Page fault)가 발생한 상황에서 가상-물리 메모리간 매핑을 담당합니다.

### Maple Tree의 노드 교체 과정에서의 MM(Memory Management) 쓰기 락

가상 메모리 영역의 정보가 업데이트 되는 과정에서 노드 교체가 발생합니다.

- 프로세스의 메모리 맵핑이 변경되는 경우
- 가상 주소 공간이 확장 또는 축소되는 경우

이런 경우 업데이트 되는 정보가 안전하게 새로운 노드에 적용되기 위해 락을 사용합니다.

- 이를 통해서 쓰기에 대한 동시성 문제를 해결합니다.

### Use-After-Free 취약점

해제된 메모리 영역을 접근할 때 발생하는 문제이자 취약점 입니다.

- 메모리를 해제한 후 해당 메모리를 가리키던 댕글링 포인터에 접근하는 등의 동작으로 인해 유발될 수 있습니다.

### RCU (Read-Copy-Update)

`Copy-on-Write`와 같이 리눅스 커널에서 사용되는 동기화 메커니즘 입니다.

- 스레드가 공유하는 자원에 대해 읽기-쓰기가 동시에 발생할 때 이를 동기화 해줍니다.
- 읽기의 경우, 락을 걸지 않고 수행합니다.
- 쓰기의 경우, 데이터를 갱신하고 이전 버전 데이터를 정리합니다.
  - 이로 인해 쓰기 작업에서 일시적으로 오버헤드가 발생할 수 있습니다.
- 커널과 같이 읽기 작업의 빈도가 높고 쓰기 작업의 빈도가 늦거나 소요 시간이 짧은 경우 유리합니다.

## 취약점 분석

- 작성 중 입니다.

## 참고 자료

- https://github.com/lrh2000/StackRot
